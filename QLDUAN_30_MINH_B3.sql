USE master
GO
--KIỂM TRA CSDL TỒN TẠI CHƯA
IF EXISTS (SELECT NAME FROM SYS.DATABASES WHERE NAME='QLDUAN_30_MINH_B3')
DROP DATABASE QLDUAN_30_MINH_B3
GO
--TẠO CSDL
CREATE DATABASE QLDUAN_30_MINH_B3
ON(NAME='QLDUAN_30_MINH_DATA', FILENAME='E:\Nguồn Demo SQL\B3 THUC HANH LOP\QLDUAN_30_MINH_B3.MDF')
LOG ON(NAME='QLDUAN_30_MINH', FILENAME='E:\Nguồn Demo SQL\B3 THUC HANH LOP\QLDUAN_30_MINH_B3.LDF')
GO

use QLDUAN_30_MINH_B3
Go
--TẠO BẢNG


CREATE TABLE PHONGBAN_30_MINH
(
	MaPB_30_MINH INT PRIMARY KEY NOT NULL,
	TenPB_30_MINH VARCHAR(10),
	TrPhong_30_MINH CHAR(9),
	NgNhanChuc_30_MINH DATETIME default(getdate()) 
	
)

CREATE TABLE NHANVIEN_30_MINH
(
	MaNV_30_MINH CHAR(9) PRIMARY KEY NOT NULL,
	Ho_30_MINH VARCHAR(15),
	TenDem_30_MINH VARCHAR(15),
	Ten_30_MINH VARCHAR(15) ,
	NgSinh_30_MINH DATETIME,
	DiaChi_30_MINH VARCHAR(50) ,
	GTinh_30_MINH NCHAR(3)CHECK (GTinh_30_MINH IN('NAM',N'NỮ')),
	Luong_30_MINH INT,
	MaGSat_30_MINH CHAR(9) references NHANVIEN_30_MINH(MaNV_30_MINH),
	Phong_30_MINH INT REFERENCES PHONGBAN_30_MINH(MaPB_30_MINH)
)

CREATE TABLE DUAN_30_MINH
(
	MaDA_30_MINH INT PRIMARY KEY NOT NULL,
	TenDA_30_MINH VARCHAR(15),
	DiaDiem_30_MINH VARCHAR(15) ,
	PhongQL_30_MINH INT references PHONGBAN_30_MINH(MaPB_30_MINH)
	

)

CREATE TABLE PHANCONG_30_MINH(
	MaNV_30_MINH CHAR(9) REFERENCES NHANVIEN_30_MINH(MaNV_30_MINH)  NOT NULL,
	MaDA_30_MINH INT REFERENCES DUAN_30_MINH(MaDA_30_MINH) NOT NULL ,
	PRIMARY KEY (MaNV_30_MINH,MaDA_30_MINH),
	SoGio_30_MINH Decimal(3,1)
)
CREATE TABLE THANNHAN_30_MINH
(
	TenTN_30_MINH CHAR(15) NOT NULL ,
	MaNV_30_MINH  CHAR(9)  NOT NULL REFERENCES NHANVIEN_30_MINH(MaNV_30_MINH),
	PRIMARY KEY(TenTN_30_MINH,MaNV_30_MINH),
	GTinh_30_MINH NCHAR(3) CHECK (GTinh_30_MINH IN('Nam',N'NỮ')),
	NgSinh_30_MINH DATETIME,
	QuanHe_30_MINH VARCHAR(10)
	
)
CREATE TABLE DIADIEM_PHONG_30_MINH
(
	DiaDiem_30_MINH VARCHAR(15)  NOT NULL,
	MaPB_30_MINH INT references PHONGBAN_30_MINH(MaPB_30_MINH) NOT NULL,
	PRIMARY KEY(DiaDiem_30_MINH,MaPB_30_MINH)
	
)








--INSERT BẢNG PHÒNG BAN
INSERT PHONGBAN_30_MINH VALUES(5, 'Nghien cuu','333445555','1988-06-22')
INSERT PHONGBAN_30_MINH VALUES(4, 'Hanh chinh','987654321','1995-01-01')
INSERT PHONGBAN_30_MINH VALUES(1, 'Giao duc','888665555','1981-06-19')
--INSERT BẢNG NHÂN VIÊN
INSERT NHANVIEN_30_MINH VALUES('123456789', 'Nguyen', 'Bao', 'Hung', '1965-01-09','73 Phan Dang Luu, Phu Nhuan, TPHCM','Nam',30000,'333445555',5 ) --3
INSERT NHANVIEN_30_MINH VALUES('333445555', 'Phan', 'Van', 'Nghia', '1962-09-15','63 Tran Huy Lieu, Phu Nhuan, TPHCM','Nam',40000,'888665555',5 )--2
INSERT NHANVIEN_30_MINH VALUES('999887777', 'Au', 'Thi', 'Vuong', '1972-07-31','32 Cao Ba Nha, Q1 , TPHCM',N'NỮ',25000,'987654321',4 )
INSERT NHANVIEN_30_MINH VALUES('987654321', 'Du', 'Thi', 'Hau', '1941-06-20','29 Bach Dang, Tan Binh , TPHCM',N'NỮ',43000,'888665555',4 )
INSERT NHANVIEN_30_MINH VALUES('666884444', 'Tran', 'Van', 'Nam', '1962-09-20','97 Dien Bien Phu, Binh Thanh, TPHCM','Nam',38000,'333445555',5 )
INSERT NHANVIEN_30_MINH VALUES('453453453', 'Hoang', 'Kim','Yen' , '1972-07-30','56 Thich Quang Duc, Phu Nhuan, TPHCM',N'NỮ',25000,'333445555',5 )
INSERT NHANVIEN_30_MINH VALUES('987987987', 'Nguyen', 'Van', 'Giap', '1969-03-30','97 Huynh Van Banh, Phu Nhuan, TPHCM','Nam',25000,'987654321',4 )
INSERT NHANVIEN_30_MINH VALUES('888665555', 'Le', 'Van', 'Bo', '1937-11-10','45 Ho Van Hue, Phu Nhuan, TPHCM','Nam',55000,NULL,1 ) --1


--INSERT DỰ ÁN
INSERT INTO DUAN_30_MINH VALUES(1,'San pham X','Tan Binh',5)
INSERT INTO DUAN_30_MINH VALUES(2,'San pham Y','Thu Duc',5)
INSERT INTO DUAN_30_MINH VALUES(3,'San pham Z','Phu Nhuan',5)
INSERT INTO DUAN_30_MINH VALUES(10,'Tin hoc hoa','Go Vap',4)
INSERT INTO DUAN_30_MINH VALUES(20,'Tai to chuc','Phu Nhuan',1)
INSERT INTO DUAN_30_MINH VALUES(30,'Phuc loi','Go Vap',4)

--INSERT PHAN CONG
INSERT INTO PHANCONG_30_MINH VALUES(123456789,'1','32.5')
INSERT INTO PHANCONG_30_MINH VALUES(123456789,'2','7.5')
INSERT INTO PHANCONG_30_MINH VALUES(666884444,'3','40.0')
INSERT INTO PHANCONG_30_MINH VALUES(453453453,'1','20.0')
INSERT INTO PHANCONG_30_MINH VALUES(453453453,'2','20.0')
INSERT INTO PHANCONG_30_MINH VALUES(333445555,'2','10.0')
INSERT INTO PHANCONG_30_MINH VALUES(333445555,'3','10.0')
INSERT INTO PHANCONG_30_MINH VALUES(333445555,'10','10.0')
INSERT INTO PHANCONG_30_MINH VALUES(333445555,'20','10.0')
INSERT INTO PHANCONG_30_MINH VALUES(999887777,'30','30')
INSERT INTO PHANCONG_30_MINH VALUES(999887777,'10','10.0')
INSERT INTO PHANCONG_30_MINH VALUES(987654321,'10','35.0')
INSERT INTO PHANCONG_30_MINH VALUES(987654321,'30','5.0')
INSERT INTO PHANCONG_30_MINH VALUES(987654321,'30','20.0')
INSERT INTO PHANCONG_30_MINH VALUES(987654321,'20','15.0')
INSERT INTO PHANCONG_30_MINH VALUES(888665555,'20',NULL)

--INSERT THANNHAN
INSERT THANNHAN_30_MINH VALUES('333445555','Anh',N'NỮ','1986-04-05','Con gai')
INSERT THANNHAN_30_MINH VALUES('333445555','The','Nam','1983-10-25','Con trai')
INSERT THANNHAN_30_MINH VALUES('333445555','Loi',N'NỮ','1958-05-03','Vo')
INSERT THANNHAN_30_MINH VALUES('987654321','An','Nam','1942-02-28','Chong')
INSERT THANNHAN_30_MINH VALUES('123456789','Minh','Nam','1988-01-04','Con trai')
INSERT THANNHAN_30_MINH VALUES('123456789','Anh',N'NỮ','1988-12-30','Con gai')
INSERT THANNHAN_30_MINH VALUES('123456789','Yen',N'NỮ','1967-05-05','Vo')

--INSERT DIADIEMPHONG
INSERT DIADIEM_PHONG_30_MINH VALUES('Phu Nhuan','1')
INSERT DIADIEM_PHONG_30_MINH VALUES('Go Vap','4')
INSERT DIADIEM_PHONG_30_MINH VALUES('Tan Binh','5')
INSERT DIADIEM_PHONG_30_MINH VALUES('Phu Nhuan','5')
INSERT DIADIEM_PHONG_30_MINH VALUES('Thu Duc','5')

DROP TABLE DIADIEM_PHONG_30_MINH,THANNHAN_30_MINH,PHANCONG_30_MINH,DUAN_30_MINH,NHANVIEN_30_MINH,PHONGBAN_30_MINH

--3.1
ALTER TABLE PHONGBAN_30_MINH ADD NamTL INT
--3.2 sua kieu du lieu
ALTER TABLE PHONGBAN_30_MINH 
ALTER COLUMN NamTL SMALLINT
--3.3 DOI TEN COT
EXEC sp_rename 'PHONGBAN_30_MINH.NamTL','NamThanhLap'
--3.4 tao rang buoc cho nam thanh lap
alter table PHONGBAN_30_MINH
add constraint NamThanhLap CHECK (NamThanhLap >=1990)
--3.5 xoa rang  buoc nam thanh lap
alter table PHONGBAN_30_MINH
drop NamThanhLap
--3.6 xoa thuoc tinh NamThanhLap ( xoa cot )
alter TABLE PHONGBAN_30_MINH
drop column NamThanhLap

--4.2 cap nhat 
UPDATE PHONGBAN_30_MINH
SET NgNhanChuc_30_MINH = '1989-06-25'
WHERE MaPB_30_MINH ='5'
--4.3 CAP NHAT TEN 
UPDATE NHANVIEN_30_MINH
SET TenDem_30_MINH = 'Hoai'
WHERE MaNV_30_MINH='666884444'

SELECT * FROM NHANVIEN_30_MINH WHERE MaNV_30_MINH='666884444'

--4.4 CAPNHAT LUONG
UPDATE NHANVIEN_30_MINH
SET Luong_30_MINH = '39000'
WHERE MaNV_30_MINH='666884444'
--4.5 CAP NHAT NGY SINH NHAN VIEN
UPDATE NHANVIEN_30_MINH
SET NgSinh_30_MINH = '1964-09-01'
WHERE MaNV_30_MINH='123456789'
SELECT * FROM NHANVIEN_30_MINH WHERE MaNV_30_MINH='123456789'

--4.6 TANG LUONG
UPDATE NHANVIEN_30_MINH
SET Luong_30_MINH = Luong_30_MINH + 1000
WHERE Phong_30_MINH = 5

SELECT * FROM NHANVIEN_30_MINH WHERE Phong_30_MINH = 5

--4.7 XOA TAT CA DIA DIEM PHONG
DELETE DIADIEM_PHONG_30_MINH
WHERE MaPB_30_MINH='5'

SELECT * FROM  DIADIEM_PHONG_30_MINH
--4.8 INSERT
INSERT INTO DIADIEM_PHONG_30_MINH VALUES('Tan Binh','5')
INSERT INTO DIADIEM_PHONG_30_MINH VALUES('Phu Nhuan','5')
INSERT INTO DIADIEM_PHONG_30_MINH VALUES('Thu Duc','5')

